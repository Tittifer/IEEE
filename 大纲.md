

**身份认证：**

1. 设备在首次部署时，会向链上提交自身的相关信息，链上会根据设备基本信息创建用户DID
2. 链上会生成用户DID，历史风险分数，攻击画像指数，攻击画像和上次事件时间的映射表
3. 风险预言机监听边缘设备，监听到蜜点被触发后向链上请求对应设备的映射表，
4. 预言机根据设备信息运行风险评估模型计算设备实时风险等级并将更新后的设备信息返还给链上
5. 设备根据返回的设备评分匹配不同的风险等级执行预设策略限制she'bei行为

------

**风险评估算法：**

- **核心跟踪参数**

  系统为每个设备在链上维护以下一组参数：

  - **$\rm S_{t-1}$  (历史风险分数)：**范围 $\rm [0, S_{max}]$,反映设备当前的即时风险水平，会随时间快速冷却。
  - **$\rm I$ (攻击画像指数)：**范围 $\rm [0, ∞)$。记录设备历史攻击行为的广度和深度，作为长期信誉的依据，衰减非常缓慢。
  - **$\rm Attack Profile$  (攻击画像)：**一个集合，用于存储设备已触发过的不重复的行为类别。
  - **$\rm t_{last}$  (上次事件时间)：**时间戳，用于计算事件间隔 $\rm Δt$。

- **算法执行流程**

  当蜜点网络捕获到一个来自某设备的风险行为时，系统按以下步骤执行：

  **步骤 1：事件识别与定性**

  系统从预言机风险行为规则库中查找该行为，获取其两个关键属性：

  - **$\rm S_{base}$ (基础风险分)**
  - **$\rm Category$ (行为类别)**
  - **$\rm W$ (行为权重)**

  **步骤 2：更新攻击画像指数 ($\rm I$ )**

  1. 检查当前 Category 是否已存在于该设备的 Attack Profile 集合中。

  2. 如果不存在 (意图升级):
     $$
     \rm \Delta I = W
     $$
     然后，将当前 Category 添加到 Attack Profile 集合中。

  3. 如果已存在 (持续试探):
     $$
     \rm \Delta I = 0
     $$

  4. 完成 $\rm I$ 的累加：
     $$
     \rm I_{new} = I_{old} + \Delta I
     $$

  **步骤 3：激活威胁状态**

  - 更新$\rm t_{last}$ 为当前事件的时间戳。

  **步骤 4：计算实时风险分 ($\rm S_t$)**

  1. 计算时间间隔 $\rm Δt$：$\rm Δt=当前时间-t_{last}$。

  2. 对历史分数进行降温:
     $$
     \rm S'_{t-1} = \max(0, S_{t-1} - \frac{\delta \cdot \Delta t}{1 + \alpha \cdot S_{t-1}})
     $$

  3. 计算最终得分:
     $$
     \rm S_t = \min(S_{max}, S_{base} \cdot (1+I)  + S'_{t-1})
     $$

  **步骤 5：后台状态维护 (周期性任务)**

  - $\rm I$慢速衰减: 确保旧的威胁记录会随时间慢慢淡化。

  $$
  \rm I_{new} = I_{old} \cdot e^{-\lambda\cdot\Delta t}
  $$

------

**风险评估规则：**

| 攻击阶段     | 事件描述               | Category                       | $\rm S_{base}$ | $\rm W$ |
| :----------- | :--------------------- | :----------------------------- | :------------- | :------ |
| **侦察**     | 访问陷阱IP             | Recon.NetworkScan              | 10             | 0.2     |
|              | 连接诱饵WiFi           | Recon.WirelessScan             | 15             | 0.2     |
|              | 对蜜点进行端口扫描     | Recon.PortScan                 | 20             | 0.2     |
| **初始接入** | 尝试弱口令登录         | InitialAccess.WeakCred         | 40             | 0.5     |
|              | 利用已知漏洞攻击       | InitialAccess.Exploit          | 80             | 0.8     |
| **执行**     | 执行信息收集命令       | Execution.Discovery            | 30             | 0.4     |
|              | 上传脚本文件           | Execution.FileUpload           | 100            | 1.0     |
|              | **上传已知后门程序**   | **Execution.Malware**          | **1000**       | \       |
|              | 修改系统配置文件       | Execution.Tamper               | 150            | 1.2     |
| **持久化**   | 创建定时任务           | Persistence.CronJob            | 120            | 1.2     |
|              | 修改系统服务           | Persistence.ServiceMod         | 150            | 1.2     |
| **防御规避** | 清空或停止日志服务     | DefenseEvasion.ClearLog        | 100            | 0.8     |
|              | **使用Rootkit技术**    | **DefenseEvasion.Rootkit**     | **1000**       | \       |
| **凭证访问** | 读取伪造的凭证文件     | CredentialAccess.File          | 200            | 1.5     |
|              | 尝试内存抓取凭证       | CredentialAccess.Memory        | 250            | 1.5     |
| **横向移动** | **使用窃取的凭证登录** | **LateralMovement.StolenCred** | **1000**       | \       |
| **数据收集** | 打包压缩敏感文件       | Collection.Archive             | 180            | 1.0     |
| **渗出**     | 向外网传输数据         | Exfiltration.DataTransfer      | 300            | 1.8     |
|              | **触发诱饵文件回调**   | **Exfiltration.CanaryToken**   | **1000**       | \       |



------

**动态风险响应策略：**

- 常规（0）：系统未检测到任何异常或风险行为。设备身份可信，行为符合预期。

  ​	策略：标准化信任与监控

  ​	具体措施：维持默认的日志记录，仅在会话建立或关键操作时通过智能合约验证其DID身份的有效性。

- 关注（1-199）： 检测到低度的、孤立的探测或扫描行为。可能为网络背景噪音、错误配置的客户端或攻击的极早期踩点。

  ​	策略：增强监控，主动引诱，无感知的情报收集。 

  ​	具体措施：针对该设备的源IP，自动启用全数据包捕获，并将其在蜜点中的所有操作行为，如输入的指令、尝试访问的文件等，进行详细日志记录。实施轻微的服务质量策略，对其扫描或连接行为进行速率限制。这不仅能拖慢其攻击节奏，还能模拟真实网络中可能存在的轻微延迟，降低其警觉性。 在其当前互动的蜜点环境中，主动暴露更具吸引力的诱饵。

- 警戒（200-699）：出现更具针对性的入侵尝试，例如对特定服务的弱口令爆破，或已成功获取了初步的、低权限的访问。攻击意图较为明显。

  ​	策略：主动欺骗与隔离引导。

  ​	具体措施：将该设备的所有内部域名解析请求指向对应的伪造服务。在网络层将其流量重定向至一个隔离的蜜网环境中，使其在无感知的情况下与真实业务网络完全隔离。在其所处的蜜网环境中，动态植入伪造的凭证文件、数据库连接字符串、API密钥等蜜点，引诱其暴露更深层次的攻击意图和横向移动路径。

- 高危（700-1000）：攻击者正在执行高危操作，如上传后门、修改关键配置、尝试提权或积极进行内部侦察。已对系统构成实质性、迫近的威胁。

  ​	策略：硬性阻断。

  ​	具体措施：立即通强制中断该设备所有已建立的网络连接。如果攻击行为与特定账户关联，立即在认证系统中临时锁定该账户。对其交互过的蜜点进行快照存证，进入人工介入和深度溯源。

------

**APT近源攻击：**

- 攻击路径：攻击者攻陷一个位于网络边缘，防护相对薄弱但受信任的设备，以此为据点向内网移动，最终达成攻击目的

- 攻击者画像：具备高技术能力，时间充足，可以持续数月甚至数年进行攻击

- 攻击面：暴露在外部的含有可利用漏洞的边缘设备

- 攻击分析：

  1. 侦察：搜索可作为入口的边缘设备

     - 使用网络空间搜索引擎搜索特定设备型号、服务或组织名称，可直接暴露在公网的边缘设备IP，开放端口等信息
     - 使用网络扫描工具对目标IP段进行端口和服务扫描，识别服务版本已匹配已知漏洞
     - 扫描目标企业可能使用的设备供应商或服务提供商，根据提供商系统存在的漏洞反向寻找所有使用该系统的客户

  2. 资源准备：为初始入侵准备工具

     - 边缘设备固件更新缓慢，因而可以根据侦察阶段获取的信息，寻找对应的漏洞利用代码
     - 准备用于目标设备上执行的后门、web shell或内存马

  3. 初始入侵：利用漏洞在边缘设备上建立第一个立足点

     - 通过SSH、Telnet等服务进行爆破或使用默认凭证尝试登录
     - 利用API或网络服务中的漏洞

  4. 执行：在设备上直接执行系统命令，或上传并运行一个二进制后门文件

  5. 持久化：确保在设备重启、连接中断后，攻击者仍能维持访问权限

     - 在设备的web服务器目录下上传一个伪装成正常界面的web shell脚本
     - 设置定时任务，定期从C2服务器下载并执行指令，确保后门持续运行
     - 下载官方固件，植入恶意代码后打包植入设备

  6. 防御规避：隐藏自身活动，避免被安全系统发现

     - 使用rootkit技术隐藏进程、网络连接和文件，或将恶意文件伪装成合法系统文件
     - 停止设备的日志服务，或清空日志记录
     - 所有与C2服务器的通信均采用TLS/SSL加密，伪装成正常的HTTPS流量

  7. 凭证访问：从已攻陷的边缘设备中获取用于横向移动的凭证

     - 边缘设备的配置文件中可能硬编码了用于访问其他内部系统的凭证
     - 利用边缘设备的位置，捕获流经该网络段的所有数据包，从中提取认证信息

  8. 发现：以边缘设备为据点，探索内部网络环境

     - 使用扫描工具扫描内网网段，寻找关键资产
     - 执行ifconfig等命令了解内网结构和路由信息

  9. 横向移动：使用获取的凭证或漏洞，向网络内部的关键系统移动

     - 使用窃取的NTML哈希值进行认证，直接访问windows系统

     - 使用窃取的凭证通过RDP、winRM、SSH等协议登录到其他服务器
     - 在发现内部系统存在漏洞时，直接利用其进行横向移动

  10. 收集：定位并汇聚目标数据

      - 在最终贡献的数据库服务器、文件服务器或用户工作站上，搜索敏感文件并将其打包压缩

  11. 命令与控制：在整个攻击过程中，维持与攻击者服务器的通信

      - 后门程序会以低频率、随机时间间隔向C2服务器发起连接，接收指令。通信协议可能伪装成正常流量以绕过防火墙

  12. 渗出：将窃取的数据传出到组织外部

      - 攻击者不直接将数据从核心服务器发送到互联网，而是先将其横向传输回最初被攻陷的边缘设备，边缘设备的出战流量不易被阻断或告警

阅读大纲文档获得背景，阅读所有的源码，修改源码，要求按照大纲文档中的风险评估算法和风险评估规则修改，链上存储的从用户信息变为设备信息，用户客户端改为设备客户端，用途是向链上发送设备注册信息，链上维护每个设备的历史风险分数，攻击画像指数，攻击画像和上次事件时间四个指数，在蜜点客户端中，更改风险评分算法，更改数据库中的风险评估规则，取消用户行为数据库，因为这部分数据被记录在链上，按这个要求更改所有的代码和相关配置

------

**背景**

​	

------

**解决问题**



------

**解决方法**

**DID设备身份管理：**

​	边缘设备在电网系统内首次部署时，电网系统会在链上为其创建一个身份唯一且不可伪造的去中心化身份标识（DID），该DID与设备相关的所有信息（如设备ID、固件版本、供应商等）通过智能合约记录在区块链上，设备在注册时生成可验证凭证（VC），该凭证由电网系统的私钥签名，设备每次通信时提供凭证用于身份验证

​	当设备首次接入时，智能合约会检查设备是否已注册。如果设备未注册，智能合约会生成DID并将设备信息写入区块链。设备的公钥、设备名称、型号、配置、历史风险行为等信息都会记录在智能合约中，同时链上会生成设备DID、风险分数与历史风险行为的映射表，初始风险分数为0，每次设备进行身份验证时，设备通过私钥签名凭证，电网系统通过区块链的智能合约来验证该凭证是否有效，从而确保设备身份不被伪造

**链下风险预言机协同：**

​	设备部署后，预言机会启用对设备的风险行为监听，在接收到设备触发风险行为的事件后，预言机会向链上请求设备的历史评分与历史风险行为，根据设备本次触发的风险行为，综合设备历史风险行为、历史风险分数、触发风险行为的时间间隔、触发频率等指标根据风险评分算法计算其实时风险等级，完成风险评分的计算后将设备的最新风险分数与最新触发的风险行为一并传回链上

**电网蜜点网络：**

1. **侦察：**攻击者已通过物理接触（如USB、串口）或接入本地网络（如Wi-Fi、以太网口）的方式，开始对边缘设备本身及其所在的本地子网进行信息收集。

   **蜜点设计：**

   ​	在边缘设备所在的VLAN或子网内，预留一部分IP地址不分配给任何正常设备。攻击者在获得本地网络访问权限后，首要动作就是扫描本地网段以发现其他存活主机。任何发往这些不使用IP的流量（如ARP请求、ICMP Echo、TCP SYN扫描）都可被100%确认为恶意侦察行为。告警信息可以直接关联到该网段对应的真实边缘设备，表明其周边存在威胁。

   ​	模拟广播与电网业务相关的、具有诱惑性的Wi-Fi SSID。这些无线网络使用弱密码或无需密码即可连接。一旦攻击者的设备尝试连接这些陷阱网络，系统即可感知到环境中存在主动的、寻找攻击入口的侦察行为。

2. **初始侵入：**攻击者利用在本地网络中发现的设备，尝试通过弱口令、默认凭证或已知漏洞获取访问权限。

   **蜜点设计：**

   ​	在本地网络中，部署多个IP，使其在网络扫描结果中呈现为与真实边缘设备同型号或相关的设备（如交换机、路由器、其他电网终端）。这些仿真设备会开放常见的管理端口（如SSH 22, Telnet 23, Web 80/443）。

   ​	在上述仿真设备蜜点开放的服务中，预置一系列具有行业特征的弱口令或默认凭证。一旦监测到任何使用这些预置账号的登录尝试，即可判定攻击者已进入入侵阶段。

3. **执行与持久化：**攻击者在攻陷的设备上执行命令、上传后门程序，并试图建立持久化的访问机制。

   **蜜点设计：**

   ​	在仿真设备蜜点中，构建一个高度仿真的文件系统。在 `/etc/`, `/tmp/`, `/home/admin/` 等敏感目录下，创建伪装成系统配置或脚本的蜜点文件（例如 `/etc/cron.d/firmware_check`, `/tmp/upload.sh`）。通过监控文件完整性，任何对这些预设文件的写入、修改或执行行为，都将被识别为攻击者在部署后门或建立持久化。

   ​	仿真设备提供一个伪造的固件升级或配置文件上传的API接口。该接口不执行任何实际操作，但会记录所有上传文件的元数据和内容。任何上传可执行脚本（如.sh, .py, ELF文件）的行为都会触发高危告警。

4. **凭证访问与内部发现：**攻击者从已控设备中搜寻访问内网其他关键系统的凭证，并以其为跳板，继续探测内部网络。

   **蜜点设计：**

   ​	在仿真设备蜜点的配置文件、环境变量或命令历史中，以明文形式存放伪造的、指向核心业务系统的凭证。

   ​	在本地网络中部署伪装成核心资产的服务。这些蜜点仅开放特定端口并返回一个服务标识，但不提供真实功能。当攻击者使用窃取的凭证尝试连接这些核心资产蜜点时，其横向移动的意图和路径便完全暴露。

5. **横向移动：**攻击者使用窃取的凭证，从一个系统横向移动到另一个系统。

   **蜜点设计：**

   ​	将在“凭证访问”阶段布设的伪造凭证在所有关键系统的认证日志中进行实时监控。网络中任何位置（无论真实设备还是蜜点）的认证日志中，一旦出现尝试使用该凭证的登录记录，即可100%确认攻击者正在进行横向移动，并能精确定位其攻击源和攻击目标。

6. **数据收集与渗出：**攻击者在定位到高价值目标后，打包敏感数据并尝试将其传出网络。

   **蜜点设计：**

   ​	在仿真设备蜜点（特别是伪装成文件服务器或数据库的蜜点）中，放置大量命名极具诱惑性的文件。这些文件一旦被攻击者下载并在其外部设备上打开，会向防御方的服务器发送一个回调请求，从而精确告警数据泄露事件。

**风险评估模型：**

​	根据风险评估规则表中的多个维度进行量化评估，评估结果用于风险评分计算

​	为应对极端威胁，制定一票否决规则。一旦攻击者行为触及最高风险红线系统将立即将其判定为最高风险

​	根据动态计算出的风险等级，系统执行差异化的响应策略，形成闭环防御

